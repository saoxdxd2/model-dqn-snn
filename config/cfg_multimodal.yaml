# Multimodal Training Config (HESC)
# Text + Vision + Structured data with capsule compression

defaults:
  - arch: multimodal_hesc
  - _self_

hydra:
  output_subdir: null

# Data paths
data_paths: ['datasets/vision_unified']
data_paths_test: []

evaluators: []

# HESC capsule mode (REQUIRED)
semantic_mode: true
semantic_dataset: "datasets/vision_unified/capsule_dataset.pt"
semantic_eval_dataset: "datasets/vision_unified/capsule_dataset_test.pt"

# Multi-Token Prediction (DeepSeek-V3 inspired)
enable_mtp: true

# DQN Enhancement Parameters
enable_dqn: true
enable_entropy_regularization: true  # Encourage Q-head to explore all 3 actions
entropy_regularization_weight: 0.01  # Small bonus for action diversity

# Memory Bank Configuration
enable_memory: true
memory_capacity: 4096
memory_num_heads: 8
memory_dropout: 0.1

# TRM Recursive Reasoning Features (NEW - ENABLED)
enable_adaptive_hcycles: true  # Early exit from H-cycles based on Q-value confidence
hcycle_confidence_threshold: 2.0  # Threshold for early exit (2.0 = ~88% probability)
enable_hierarchical_attention: true  # Parent-child attention bias for capsule structure
enable_capsule_expansion: true  # Capsule expansion via DQN (FULL SUPPORT with children embeddings)
q_head_num_actions: 3  # Q-head actions: [HALT, CONTINUE, EXPAND]
q_head_type: "mlp"  # Options: mlp, rnn, mini_attention

# Training hyperparameters (optimized for 12-capsule sequences)
image_size: 128  # Reduced from 224 to fit 100k samples in 12GB RAM
global_batch_size: 768  # High batch for capsule compression
epochs: 50000
eval_interval: 1000
checkpoint_every_eval: True

# Learning rates
lr: 3e-4  # Higher for multimodal (diverse data)
lr_min_ratio: 0.1
lr_warmup_steps: 1000

# Optimizer (AdamW)
beta1: 0.9
beta2: 0.95
weight_decay: 0.05  # Medium regularization

# Puzzle embeddings (for multi-task)
puzzle_emb_lr: 1e-3
puzzle_emb_weight_decay: 0.1

seed: 42
min_eval_interval: 0
encoder_model: openai/clip-vit-base-patch32

checkpoint_path: "checkpoints/multimodal-hesc"

# Project naming
project_name: "Multimodal-HESC"
run_name: null

# EMA (stability for mixed data)
ema: True
ema_rate: 0.999

freeze_weights: False
